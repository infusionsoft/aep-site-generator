---
import { Icon } from '@astrojs/starlight/components';
import SidebarSublist from '@astrojs/starlight/components/SidebarSublist.astro';
import type { StarlightRouteData } from '@astrojs/starlight/route-data';
import TabbedContent from '../tabs/TabbedContent.astro';
import TabListItem from '../tabs/TabListItem.astro';
import TabPanel from '../tabs/TabPanel.astro';
import MobileMenuFooter from '../starlight/MobileMenuFooter.astro';
import { getEditionFromPath, isLatestEdition } from '../../utils/versions';
import editionsConfig from '../../../aep-editions.json';
import siteStructure from '../../../generated/site-structure.json';

const { id } = Astro.locals.starlightRoute;

// Get current edition based on the path
const currentEdition = getEditionFromPath(editionsConfig, Astro.url.pathname);
const editionKey = currentEdition?.folder === '.' ? 'general' : currentEdition?.folder || 'general';

// Build the base sidebar structure from site-structure.json
const baseSidebar = [
  {
    type: 'group' as const,
    label: siteStructure.overview.metadata.label,
    entries: siteStructure.overview.pages.map((page: any) => ({
      type: 'link' as const,
      label: page.label,
      href: `/${page.link}`,
      isCurrent: false,
      badge: undefined,
      attrs: {}
    })),
    collapsed: false,
    badge: undefined
  },
  {
    type: 'group' as const,
    label: siteStructure.aeps.metadata.label,
    entries: [], // Will be populated by buildAepSidebar()
    collapsed: false,
    badge: undefined
  }
];

// Always use the base sidebar we constructed (with all tabs)
const sidebar = baseSidebar;

// Helper to build edition-aware AEP link
function buildAepLink(aepId: string | number): string {
  const aepNumber = String(aepId);
  if (!isLatestEdition(currentEdition)) {
    return `/${currentEdition!.folder}/${aepNumber}`;
  }
  return `/${aepNumber}`;
}

type SidebarEntry = StarlightRouteData['sidebar'][number];

// Helper function to strip leading and trailing slashes
function stripLeadingAndTrailingSlashes(path: string): string {
  return path.replace(/^\//, '').replace(/\/$/, '');
}

// Mark current entries
function markEntries(i: SidebarEntry) {
  if (i.type === 'group') {
    i.entries.forEach(markEntries);
  } else {
    const itemSlug = stripLeadingAndTrailingSlashes(i.href);
    i.isCurrent ||= id === itemSlug;
  }
}

let sidebarToUse = sidebar;

// Convert any top-level links to groups
const normalizedSidebar = sidebarToUse.map((entry): Group => {
  if (entry.type === 'link') {
    // Convert link to a group with the link as its only entry
    return {
      type: 'group',
      label: entry.label,
      entries: [entry],
      collapsed: false,
      badge: entry.badge
    };
  }
  return entry as Group;
});

normalizedSidebar.forEach(markEntries);

const makeId = (label: string) => '__tab-' + label.toLowerCase().replaceAll(/\s+/g, '-');
const isCurrent = (sidebar: SidebarEntry[]): boolean =>
  sidebar
    .map((entry) => (entry.type === 'link' ? entry.isCurrent : isCurrent(entry.entries)))
    .some((entry) => entry === true);

// Get icon from site structure metadata
function getIconForSection(label: string): string {
  // Map section labels to their metadata in site structure
  const sectionMap: Record<string, string> = {
    'Overview': siteStructure.overview.metadata.icon,
    'AEPs': siteStructure.aeps.metadata.icon,
  };
  return sectionMap[label] || 'bars';
}

// Function to build AEP sidebar from site structure based on current edition
function buildAepSidebar(): SidebarEntry[] {
  const aepsData = (siteStructure as any).aeps?.editions?.[editionKey];
  if (!aepsData || !aepsData.categories) {
    return [];
  }

  // Extract the AEP number from the current page id (e.g., "aep-2026/123" -> "123")
  const currentAepId = id.split('/').pop();

  return aepsData.categories.map((category: any) => ({
    type: 'group' as const,
    label: category.title,
    entries: category.aeps.map((aep: any) => ({
      type: 'link' as const,
      label: `${aep.id}. ${aep.title}`,
      href: buildAepLink(aep.id),
      isCurrent: currentAepId === String(aep.id),
      badge: undefined,
      attrs: {}
    })),
    collapsed: false,
    badge: undefined
  }));
}

// Populate sections with their content
const modifiedSidebar = normalizedSidebar.map(group => {
  // Populate AEPs section with edition-specific content
  if (group.label === siteStructure.aeps.metadata.label) {
    return {
      ...group,
      entries: buildAepSidebar()
    };
  }

  return group;
});
---

<TabbedContent class="tabbed-sidebar">
    <Fragment slot="tab-list">
      {
        modifiedSidebar.map(({ label, entries }) => (
                <TabListItem id={makeId(label)} initial={isCurrent(entries)} class="tab-item">
                    <Icon class="icon" name={getIconForSection(label)} /> {label}
                </TabListItem>
        ))
      }
    </Fragment>
  {
    modifiedSidebar.map(({ label, entries }) => (
            <TabPanel id={makeId(label)} initial={isCurrent(entries)}>
                <SidebarSublist sublist={entries} />
            </TabPanel>
    ))
  }
</TabbedContent>

<div class="md:sl-hidden">
    <MobileMenuFooter />
</div>

<style>
    /** Always show the scrollbar gutter. */
    :global(.sidebar-pane) {
        overflow-y: scroll;
    }

    /* Styles for the custom tab switcher. */
    .tabbed-sidebar {
        /* Layout variables */
        --tab-switcher-border-width: 1px;
        --tab-switcher-padding: calc(0.25rem - var(--tab-switcher-border-width));
        --tab-item-border-radius: 0.5rem;
        --tab-switcher-border-radius: calc(
                var(--tab-item-border-radius) + var(--tab-switcher-padding) + var(--tab-switcher-border-width)
        );

        /* Color variables */
        --tab-switcher-border-color: var(--sl-color-hairline-light);
        --tab-switcher-background-color: var(--sl-color-gray-7, var(--sl-color-gray-6));
        --tab-switcher-text-color: var(--sl-color-gray-3);
        --tab-switcher-text-color--active: var(--sl-color-white);
        --tab-switcher-icon-color: var(--sl-color-gray-4);
        --tab-switcher-icon-color--active: var(--sl-color-text-accent);
        --tab-item-background-color--hover: var(--sl-color-gray-6);
        --tab-item-background-color--active: var(--sl-color-black);

        /* Add separator line and spacing below the entire tab switcher */
        border-bottom: 1px solid var(--sl-color-hairline-light);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    /* Dark theme variations */
    :global([data-theme='dark']) .tabbed-sidebar {
        --tab-switcher-text-color: var(--sl-color-gray-2);
        --tab-switcher-icon-color: var(--sl-color-gray-3);
        --tab-item-background-color--hover: var(--sl-color-gray-5);
    }

    @media (min-width: 50rem) {
        /* Dark theme variations with the desktop sidebar visible */
        :global([data-theme='dark']) .tabbed-sidebar {
            --tab-switcher-background-color: var(--sl-color-black);
            --tab-item-background-color--hover: var(--sl-color-gray-6);
            --tab-item-background-color--active: var(--sl-color-gray-6);
        }
    }

    .tabbed-sidebar :global(.tab-list) {
        border: var(--tab-switcher-border-width) solid var(--tab-switcher-border-color);
        border-radius: var(--tab-switcher-border-radius);
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding: var(--tab-switcher-padding);
        background-color: var(--tab-switcher-background-color);
        margin-bottom: 0;
    }

    .tab-item :global(a) {
        border: var(--tab-switcher-border-width) solid transparent;
        border-radius: var(--tab-item-border-radius);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: calc(0.5rem - var(--tab-switcher-border-width));
        background-clip: padding-box;
        line-height: var(--sl-line-height-headings);
        text-decoration: none;
        color: var(--tab-switcher-text-color);
        font-weight: 600;
    }

    .tab-item :global(a:hover) {
        color: var(--tab-switcher-text-color--active);
        background-color: var(--tab-item-background-color--hover);
    }

    .tab-item :global(a[aria-selected='true']) {
        border-color: var(--tab-switcher-border-color);
        color: var(--tab-switcher-text-color--active);
        background-color: var(--tab-item-background-color--active);
    }

    .icon {
        margin: 0.25rem;
        color: var(--tab-switcher-icon-color);
    }

    .tab-item :global(a:hover) .icon {
        color: inherit;
    }

    .tab-item :global(a[aria-selected='true']) .icon {
        color: var(--tab-switcher-icon-color--active);
    }
</style>
